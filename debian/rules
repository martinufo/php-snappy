#!/usr/bin/make -f

export DH_OPTIONS

CFLAGS = -O2 -Wall
CFLAGS += -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64
ifneq (,$(findstring debug,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -g
	DEBUG := --enable-debug
else
	DEBUG := --disable-debug
endif

TAR=tar
PECL_PKG_NAME=snappy
PECL_PKG_REALNAME=snappy
PECL_PKG_VERSION=0.0.2
PACKAGE_NAME=php-snappy
BIN_PACKAGE_NAME=php5-snappy
PHPIZE=/usr/bin/phpize
PHPCONFIG=/usr/bin/php-config
EXT_DIR=$(shell $(PHPCONFIG) --extension-dir)
SOURCE_DIR=$(shell ls -d .)

phpapiver=$(shell $(PHPCONFIG) --phpapi)

configure: config.h

config.h:
	dh_testdir
	# Add here commands to configure the package.
	(cd $(SOURCE_DIR); \
	$(PHPIZE); \
	./configure --with-php-config=$(PHPCONFIG) --prefix=/usr)
	touch $@

build: modules/$(PECL_PKG_NAME).so

modules/$(PECL_PKG_NAME).so: config.h
	$(shell /usr/share/dh-make-php/phppkginfo package2.xml changelog > debian/Changelog)
	dh_testdir

	# Add here commands to compile the package.
	(cd $(SOURCE_DIR); $(MAKE); mkdir -p ../tmp/modules; cp modules/* ../tmp/modules;) # $(MAKE) clean
	touch $@

clean:
	dh_testdir
	dh_testroot
	rm -f modules/$(PECL_PKG_NAME).so config.h
	# Add here commands to clean up after the build process.
	(cd $(SOURCE_DIR); \
	$(MAKE) clean; \
	$(PHPIZE) --clean)
	dh_clean

install: build
	dh_testdir
	dh_testroot
	# can't dh_clean here without specifically excluding the possibly existing installed dirs
	# for other version.
	#dh_clean -k
	dh_installdirs

	# Add here commands to install the package into debian/$(PACKAGE_NAME).
	mkdir -p debian/$(BIN_PACKAGE_NAME)/$(EXT_DIR)
	install -m 644 -o root -g root ../tmp/modules/$(PECL_PKG_NAME).so debian/$(BIN_PACKAGE_NAME)/$(EXT_DIR)/$(PECL_PKG_NAME).so
	if [ -f "debian/$(PECL_PKG_NAME).ini" ]; then \
		mkdir -p debian/$(BIN_PACKAGE_NAME)/etc/php5/mods-available; \
		cp debian/$(PECL_PKG_NAME).ini debian/$(BIN_PACKAGE_NAME)/etc/php5/mods-available; \
	fi

# Build architecture-independent files here.
binary-indep:
# We have nothing to do by default.

# Build architecture-dependent files here.

binary-arch: install
	echo "php:Depends=phpapi-$(phpapiver)" >> debian/$(BIN_PACKAGE_NAME).substvars
	dh_testdir
	dh_testroot
	dh_installchangelogs debian/Changelog
	dh_installdocs
	dh_installexamples
#	dh_install --sourcedir=debian/$(BIN_PACKAGE_NAME)
	dh_installdebconf	
#	dh_link
ifeq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
	dh_strip
endif
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure

